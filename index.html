import React, { useState, useEffect, useRef } from 'react';
import { 
  Satellite, 
  Activity, 
  Cpu, 
  Zap, 
  Trash2, 
  Terminal as TermIcon, 
  Box, 
  Info, 
  ChevronRight, 
  AlertCircle 
} from 'lucide-react';
import * as THREE from 'three';

// --- CONFIGURACIÓN TÉCNICA MASTER ---
const WINNING_UUID = '000018f0-0000-1000-8000-00805f9b34fb';
const BACKUP_UUIDS = [
  '0000fff0-0000-1000-8000-00805f9b34fb',
  '49535343-fe7d-4ae5-8fa9-9fafd205e455',
  '0000ffe0-0000-1000-8000-00805f9b34fb'
];

export default function App() {
  const [activeTab, setActiveTab] = useState('diag');
  const [isConnected, setIsConnected] = useState(false);
  const [logs, setLogs] = useState([{ time: new Date().toLocaleTimeString(), text: "Sistema Quantum V10.5 Listo. Socio Millán al mando.", type: "sys" }]);
  const [dtcs, setDtcs] = useState([]);
  const [deviceInfo, setDeviceInfo] = useState({ name: "Desconectado", battery: "0.0V" });
  const [isScanning, setIsScanning] = useState(false);
  
  const obdCharRef = useRef(null);
  const bleDeviceRef = useRef(null);
  const threeRootRef = useRef(null);
  const consoleEndRef = useRef(null);

  // Auto-scroll para la terminal
  useEffect(() => {
    consoleEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [logs]);

  // --- MOTOR 3D HOLOGRÁFICO ---
  useEffect(() => {
    if (activeTab === 'lab' && threeRootRef.current) {
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, threeRootRef.current.clientWidth / 300, 0.1, 1000);
      const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(threeRootRef.current.clientWidth, 300);
      threeRootRef.current.appendChild(renderer.domElement);

      const light = new THREE.PointLight(0x22d3ee, 5, 100);
      light.position.set(10, 10, 10);
      scene.add(light);
      scene.add(new THREE.AmbientLight(0x404040, 2));

      const geometry = new THREE.TorusKnotGeometry(1, 0.3, 100, 16);
      const material = new THREE.MeshPhongMaterial({ 
        color: 0x22d3ee, 
        wireframe: true, 
        transparent: true, 
        opacity: 0.8,
        emissive: 0x22d3ee,
        emissiveIntensity: 0.5
      });
      const torusKnot = new THREE.Mesh(geometry, material);
      scene.add(torusKnot);

      camera.position.z = 4;

      const animate = () => {
        requestAnimationFrame(animate);
        torusKnot.rotation.x += 0.01;
        torusKnot.rotation.y += 0.01;
        renderer.render(scene, camera);
      };
      animate();

      return () => {
        if (threeRootRef.current) threeRootRef.current.innerHTML = '';
      };
    }
  }, [activeTab]);

  // --- LÓGICA DE COMUNICACIÓN BLUETOOTH ---
  const addLog = (text, type = "sys") => {
    setLogs(prev => [...prev, { time: new Date().toLocaleTimeString(), text, type }]);
  };

  const connectDevice = async () => {
    try {
      addLog("Iniciando Discovery Loop Cuántico...", "sys");
      const device = await navigator.bluetooth.requestDevice({
        acceptAllDevices: true,
        optionalServices: [WINNING_UUID, ...BACKUP_UUIDS]
      });

      addLog(`Vinculado con: ${device.name}`, "sys");
      const server = await device.gatt.connect();
      const services = await server.getPrimaryServices();
      
      let foundChar = null;
      for (const s of services) {
        const chars = await s.getCharacteristics();
        for (const c of chars) {
          if (c.properties.write || c.properties.writeWithoutResponse) {
            foundChar = c;
            break;
          }
        }
        if (foundChar) break;
      }

      if (!foundChar) throw new Error("No se halló canal de datos abierto.");

      if (foundChar.properties.notify) {
        await foundChar.startNotifications();
        foundChar.addEventListener('characteristicvaluechanged', (e) => {
          const val = new TextDecoder().decode(e.target.value).trim();
          if (val) addLog(val, "rx");
        });
      }

      obdCharRef.current = foundChar;
      bleDeviceRef.current = device;
      setIsConnected(true);
      setDeviceInfo(prev => ({ ...prev, name: device.name }));
      addLog("Enlace VLink Establecido. Mandando ATI.", "sys");
      await sendCommand("ATI");
    } catch (err) {
      addLog(`Error: ${err.message}`, "err");
    }
  };

  const sendCommand = async (cmd) => {
    if (!obdCharRef.current) return;
    try {
      await obdCharRef.current.writeValue(new TextEncoder().encode(cmd + "\r"));
      addLog(cmd, "tx");
    } catch (e) {
      addLog("Fallo en canal de datos.", "err");
    }
  };

  const readDTC = async () => {
    if (!isConnected) return;
    setIsScanning(true);
    addLog("Pidiendo códigos de falla (Modo 03)...", "sys");
    await sendCommand("03");
    // Simulacro de decodificación para visualización si no hay respuesta real inmediata
    setTimeout(() => {
      setIsScanning(false);
      // Aquí se procesaría la respuesta real RX
    }, 2000);
  };

  // --- COMPONENTES DE UI ---
  const NavButton = ({ id, label, icon: Icon }) => (
    <button 
      onClick={() => setActiveTab(id)}
      className={`flex-1 flex flex-col items-center py-3 rounded-2xl transition-all ${activeTab === id ? 'bg-cyan-500/20 text-cyan-400 border-b-2 border-cyan-400' : 'text-slate-500 hover:bg-slate-800'}`}
    >
      <Icon size={18} className="mb-1" />
      <span className="text-[10px] font-black uppercase tracking-widest italic">{label}</span>
    </button>
  );

  return (
    <div className="min-h-screen bg-slate-950 text-slate-100 flex flex-col font-sans selection:bg-cyan-500/30">
      
      {/* Header Premium */}
      <header className="p-4 bg-slate-900/50 backdrop-blur-xl border-b border-white/5 sticky top-0 z-50">
        <div className="max-w-4xl mx-auto flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="p-2 bg-gradient-to-br from-cyan-400 to-blue-600 rounded-lg shadow-lg shadow-cyan-500/20">
              <Zap size={20} className="text-slate-950" />
            </div>
            <div>
              <h1 className="text-xl font-black tracking-tighter italic uppercase leading-none">
                Propart <span className="text-cyan-400">Master</span>
              </h1>
              <p className="text-[9px] font-bold text-slate-500 tracking-[0.3em] uppercase mt-1">Socio: Millán | V10.5 Quantum</p>
            </div>
          </div>
          
          <div className="flex items-center gap-3 bg-slate-950/50 px-4 py-2 rounded-full border border-white/5 shadow-inner">
            <div className={`w-2.5 h-2.5 rounded-full transition-all duration-500 ${isConnected ? 'bg-cyan-400 shadow-[0_0_10px_#22d3ee] animate-pulse' : 'bg-slate-700'}`}></div>
            <span className="text-[10px] font-black uppercase tracking-widest text-slate-400">
              {isConnected ? 'Link Active' : 'Offline'}
            </span>
          </div>
        </div>

        <nav className="max-w-md mx-auto flex gap-2 mt-4 bg-slate-950/50 p-1 rounded-2xl border border-white/5">
          <NavButton id="diag" label="Escanear" icon={Activity} />
          <NavButton id="bench" label="Test Banco" icon={Cpu} />
          <NavButton id="lab" label="3D Lab" icon={Box} />
        </nav>
      </header>

      <main className="flex-grow p-4 max-w-4xl mx-auto w-full space-y-6 overflow-y-auto">
        
        {activeTab === 'diag' && (
          <div className="space-y-4 animate-in fade-in slide-in-from-bottom-4">
            <div className="grid grid-cols-2 gap-4">
              <button 
                onClick={connectDevice}
                className={`p-6 rounded-3xl flex flex-col items-center gap-3 border transition-all shadow-xl ${isConnected ? 'bg-cyan-500/10 border-cyan-500/40 text-cyan-400' : 'bg-slate-900 border-white/5 text-slate-400'}`}
              >
                <Satellite size={28} className={isConnected ? 'animate-pulse' : ''} />
                <span className="text-[10px] font-black uppercase tracking-widest">Sincronizar Vlink</span>
              </button>
              
              <button 
                onClick={readDTC}
                disabled={!isConnected}
                className="bg-slate-900 border border-white/5 p-6 rounded-3xl flex flex-col items-center gap-3 text-amber-500 shadow-xl disabled:opacity-30 disabled:grayscale transition-all hover:bg-slate-800"
              >
                <Cpu size={28} className={isScanning ? 'animate-spin' : ''} />
                <span className="text-[10px] font-black uppercase tracking-widest">Leer Fallas (DTC)</span>
              </button>
            </div>

            <div className="bg-slate-900/50 rounded-3xl border border-white/5 p-6 shadow-2xl">
              <h3 className="text-xs font-black text-slate-500 uppercase tracking-[0.2em] mb-4 flex items-center gap-2 italic">
                <AlertCircle size={14} className="text-rose-500" />
                Códigos en Memoria ECU
              </h3>
              
              {dtcs.length === 0 ? (
                <div className="py-12 border-2 border-dashed border-slate-800 rounded-2xl flex flex-col items-center justify-center text-slate-700">
                  <Info size={40} className="mb-2 opacity-20" />
                  <p className="text-[10px] font-bold uppercase italic tracking-widest">Sin datos de diagnóstico</p>
                </div>
              ) : (
                <div className="space-y-3">
                  {/* Mapeo de DTCs */}
                </div>
              )}
            </div>
          </div>
        )}

        {activeTab === 'bench' && (
          <div className="space-y-4 animate-in fade-in">
            <div className="grid grid-cols-2 gap-3">
              <button onClick={() => sendCommand("ATI")} className="bg-slate-900 border border-white/5 p-5 rounded-2xl flex flex-col items-center gap-2 hover:bg-slate-800 transition-colors">
                <Cpu size={20} className="text-emerald-400" />
                <span className="text-[9px] font-black uppercase">Hardware Info</span>
              </button>
              <button onClick={() => sendCommand("ATRV")} className="bg-slate-900 border border-white/5 p-5 rounded-2xl flex flex-col items-center gap-2 hover:bg-slate-800 transition-colors">
                <Zap size={20} className="text-amber-400" />
                <span className="text-[9px] font-black uppercase">Leer Voltaje</span>
              </button>
            </div>

            <div className="terminal-box p-4 flex flex-col h-96 shadow-2xl">
              <div className="flex justify-between items-center mb-3 border-b border-white/10 pb-2">
                <span className="text-[10px] font-black text-cyan-400 uppercase italic flex items-center gap-2">
                  <TermIcon size={12} />
                  Quantum Engineering Log
                </span>
                <button 
                  onClick={() => setLogs([])}
                  className="text-[9px] text-slate-500 hover:text-white transition-colors"
                >
                  PURGAR
                </button>
              </div>
              <div className="flex-grow overflow-y-auto custom-scroll space-y-1 font-mono text-[11px]">
                {logs.map((log, i) => (
                  <div key={i} className="flex gap-2">
                    <span className="text-slate-700 font-bold">[{log.time}]</span>
                    <span className={
                      log.type === 'tx' ? 'text-white font-bold italic' : 
                      log.type === 'rx' ? 'text-cyan-400 font-black' : 
                      log.type === 'err' ? 'text-rose-500' : 'text-slate-500'
                    }>
                      {log.type === 'tx' ? 'ENVIANDO > ' : log.type === 'rx' ? 'RECIBIDO < ' : 'ESTADO | '}
                      {log.text}
                    </span>
                  </div>
                ))}
                <div ref={consoleEndRef} />
              </div>
            </div>
          </div>
        )}

        {activeTab === 'lab' && (
          <div className="space-y-4 animate-in fade-in">
            <div className="bg-slate-900 border border-cyan-500/20 rounded-3xl overflow-hidden shadow-2xl relative">
              <div ref={threeRootRef} id="canvas-3d" />
              <div className="absolute bottom-4 left-0 right-0 text-center pointer-events-none">
                <p className="text-xs font-black text-white uppercase tracking-[0.4em] italic drop-shadow-md">Inspección Holográfica</p>
              </div>
            </div>
            
            <div className="bg-slate-900/50 p-5 rounded-2xl border border-white/5 border-l-4 border-amber-500">
                <h4 className="text-[10px] font-black text-amber-500 uppercase italic">Referencia de Banqueo</h4>
                <div className="mt-2 text-[11px] text-slate-300 space-y-1 font-medium">
                  <p>• Pin 16: Alimentación (+) 12V Batería</p>
                  <p>• Pin 04: Tierra (-) Chasis</p>
                  <p>• Pin 05: Tierra (-) Señal</p>
                </div>
            </div>
          </div>
        )}

      </main>

      {/* Footer Command Line */}
      <footer className="p-4 bg-slate-900 border-t border-white/5 sticky bottom-0 z-50">
        <div className="max-w-4xl mx-auto flex gap-2">
          <input 
            type="text" 
            placeholder="Enviar AT o HEX Manual (Ej: 03)..."
            className="flex-grow bg-slate-950 border border-white/10 rounded-2xl px-5 py-3.5 text-xs text-white outline-none focus:ring-1 focus:ring-cyan-500 transition-all font-bold uppercase placeholder:text-slate-800"
            onKeyDown={(e) => {
              if (e.key === 'Enter') {
                sendCommand(e.currentTarget.value.toUpperCase());
                e.currentTarget.value = '';
              }
            }}
          />
          <button 
            onClick={() => {
              const input = document.querySelector('input');
              sendCommand(input.value.toUpperCase());
              input.value = '';
            }}
            className="bg-cyan-600 p-4 rounded-2xl text-slate-950 active:scale-90 transition-transform shadow-lg shadow-cyan-900/20"
          >
            <ChevronRight size={18} />
          </button>
        </div>
        <p className="text-center text-[7px] text-slate-700 font-bold uppercase tracking-[0.5em] mt-3 italic italic">
          JULS AI SPECIALIST | PROPART DIAGNOSTIC MASTER © 2026 | SOCIO MILLÁN
        </p>
      </footer>
    </div>
  );
}
