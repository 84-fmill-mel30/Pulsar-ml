
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProPart AI - Diagn√≥stico Inteligente</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a1128 0%, #1a2332 100%);
            color: #fff;
            min-height: 100vh;
            padding: 10px;
            padding-bottom: 80px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(0, 183, 255, 0.3);
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(135deg, #00b7ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }

        .subtitle {
            color: #6eb6d8;
            font-size: 14px;
        }

        .ai-badge {
            display: inline-block;
            background: linear-gradient(135deg, #9333ea, #ec4899);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            margin-top: 5px;
            font-weight: 600;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(0, 183, 255, 0.3);
        }

        .status-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .status-icon {
            width: 40px;
            height: 40px;
            background: rgba(0, 183, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .status-title {
            font-size: 16px;
            font-weight: 600;
            color: #00b7ff;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.disconnected { background: #ff4444; }
        .status-dot.connecting { background: #ffaa00; }
        .status-dot.connected { background: #00ff88; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00b7ff 0%, #0088cc 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 183, 255, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(0, 183, 255, 0.3);
        }

        .btn-ai {
            background: linear-gradient(135deg, #9333ea 0%, #ec4899 100%);
            color: white;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .tab {
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 183, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            font-size: 13px;
        }

        .tab.active {
            background: rgba(0, 183, 255, 0.2);
            border-color: #00b7ff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .data-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }

        .data-label {
            font-size: 11px;
            color: #888;
            margin-bottom: 5px;
        }

        .data-value {
            font-size: 22px;
            font-weight: bold;
            color: #00b7ff;
        }

        .data-unit {
            font-size: 12px;
            color: #6eb6d8;
        }

        .brand-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .brand-btn {
            padding: 15px 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(0, 183, 255, 0.3);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
        }

        .brand-btn:hover {
            background: rgba(0, 183, 255, 0.1);
            border-color: #00b7ff;
            transform: translateY(-2px);
        }

        .brand-btn.selected {
            background: rgba(0, 183, 255, 0.2);
            border-color: #00b7ff;
        }

        .error-list {
            margin-top: 15px;
        }

        .error-item {
            background: rgba(255, 68, 68, 0.1);
            border-left: 4px solid #ff4444;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 5px;
        }

        .error-code {
            font-weight: bold;
            color: #ff4444;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .error-desc {
            font-size: 12px;
            color: #ccc;
        }

        .log {
            background: rgba(0, 0, 0, 0.5);
            padding: 12px;
            border-radius: 10px;
            max-height: 150px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            margin-top: 15px;
        }

        .log-entry {
            margin-bottom: 5px;
            color: #aaa;
        }

        .log-entry.error { color: #ff4444; }
        .log-entry.success { color: #00ff88; }
        .log-entry.info { color: #00b7ff; }

        /* Claude AI Assistant */
        .ai-assistant {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, rgba(10, 17, 40, 0.95) 0%, rgba(10, 17, 40, 0.98) 100%);
            border-top: 2px solid rgba(147, 51, 234, 0.5);
            box-shadow: 0 -5px 30px rgba(147, 51, 234, 0.3);
            z-index: 1000;
            transition: all 0.3s;
        }

        .ai-assistant.collapsed {
            bottom: -calc(100% - 50px);
        }

        .ai-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: rgba(147, 51, 234, 0.2);
            cursor: pointer;
        }

        .ai-header:hover {
            background: rgba(147, 51, 234, 0.3);
        }

        .ai-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .ai-icon {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #9333ea, #ec4899);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .ai-chat {
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
        }

        .ai-message {
            margin-bottom: 12px;
            padding: 10px 12px;
            border-radius: 10px;
            font-size: 13px;
            line-height: 1.5;
        }

        .ai-message.user {
            background: rgba(0, 183, 255, 0.2);
            margin-left: 20px;
        }

        .ai-message.claude {
            background: rgba(147, 51, 234, 0.2);
            margin-right: 20px;
        }

        .ai-message .sender {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 11px;
            opacity: 0.8;
        }

        .ai-input-container {
            padding: 12px 15px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(147, 51, 234, 0.3);
        }

        .ai-input-group {
            display: flex;
            gap: 10px;
        }

        .ai-input {
            flex: 1;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(147, 51, 234, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 14px;
        }

        .ai-input:focus {
            outline: none;
            border-color: #9333ea;
            background: rgba(255, 255, 255, 0.08);
        }

        .ai-send-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #9333ea, #ec4899);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }

        .ai-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(147, 51, 234, 0.4);
        }

        .ai-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .ai-quick-actions {
            display: flex;
            gap: 8px;
            padding: 0 15px 12px;
            overflow-x: auto;
        }

        .quick-action {
            padding: 6px 12px;
            background: rgba(147, 51, 234, 0.2);
            border: 1px solid rgba(147, 51, 234, 0.3);
            border-radius: 15px;
            font-size: 11px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .quick-action:hover {
            background: rgba(147, 51, 234, 0.3);
            transform: translateY(-2px);
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00b7ff;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .help-text {
            font-size: 11px;
            color: #888;
            margin-top: 10px;
            padding: 8px;
            background: rgba(255, 170, 0, 0.1);
            border-radius: 5px;
            border-left: 3px solid #ffaa00;
        }

        .toggle-icon {
            transition: transform 0.3s;
        }

        .ai-assistant.collapsed .toggle-icon {
            transform: rotate(180deg);
        }

        @media (max-width: 768px) {
            .data-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üîß PROPART AI</div>
            <div class="subtitle">DIAGN√ìSTICO PROFESIONAL INTELIGENTE</div>
            <div class="ai-badge">ü§ñ Con Asistente Claude</div>
        </div>

        <div class="status-card">
            <div class="status-header">
                <div class="status-icon">üöó</div>
                <div class="status-title">SELECCIONA TU MARCA</div>
            </div>

            <div class="brand-selector">
                <div class="brand-btn" onclick="selectBrand('Toyota')">üî¥ Toyota</div>
                <div class="brand-btn" onclick="selectBrand('Honda')">üîµ Honda</div>
                <div class="brand-btn" onclick="selectBrand('Nissan')">‚ö´ Nissan</div>
                <div class="brand-btn" onclick="selectBrand('Mazda')">üî¥ Mazda</div>
                <div class="brand-btn" onclick="selectBrand('Ford')">üîµ Ford</div>
                <div class="brand-btn" onclick="selectBrand('Chevrolet')">üü° Chevrolet</div>
                <div class="brand-btn" onclick="selectBrand('BMW')">‚ö™ BMW</div>
                <div class="brand-btn" onclick="selectBrand('Mercedes')">‚ö™ Mercedes</div>
                <div class="brand-btn" onclick="selectBrand('Audi')">‚ö´ Audi</div>
                <div class="brand-btn" onclick="selectBrand('Volkswagen')">üîµ VW</div>
                <div class="brand-btn" onclick="selectBrand('Hyundai')">üîµ Hyundai</div>
                <div class="brand-btn" onclick="selectBrand('Kia')">üî¥ Kia</div>
                <div class="brand-btn" onclick="selectBrand('Subaru')">üîµ Subaru</div>
                <div class="brand-btn" onclick="selectBrand('Mitsubishi')">üî¥ Mitsubishi</div>
                <div class="brand-btn" onclick="selectBrand('Jeep')">üü¢ Jeep</div>
                <div class="brand-btn" onclick="selectBrand('Dodge')">üî¥ Dodge</div>
            </div>

            <div id="brandInfo" style="margin-top: 15px; padding: 12px; background: rgba(0, 183, 255, 0.1); border-radius: 8px; display: none;">
                <div style="font-weight: 600; margin-bottom: 5px;">Marca seleccionada: <span id="selectedBrand"></span></div>
                <div style="font-size: 12px; color: #aaa;">Configuraci√≥n optimizada para diagn√≥stico</div>
            </div>
        </div>

        <div class="status-card">
            <div class="status-header">
                <div class="status-icon">üì°</div>
                <div class="status-title">CONEXI√ìN ELM327</div>
            </div>

            <div class="connection-status">
                <div class="status-dot disconnected" id="statusDot"></div>
                <div id="statusText">Desconectado</div>
            </div>

            <button class="btn btn-primary" id="scanBtn" onclick="scanDevices()">
                üîç Buscar Dispositivo ELM327
            </button>

            <button class="btn btn-secondary" onclick="scanAllDevices()">
                üì° Buscar TODOS los Dispositivos
            </button>

            <button class="btn btn-primary" id="connectBtn" style="display: none;" onclick="connectDevice()">
                üîå Conectar al Dispositivo
            </button>

            <button class="btn btn-secondary" id="disconnectBtn" style="display: none;" onclick="disconnect()">
                ‚ùå Desconectar
            </button>

            <div class="help-text">
                üí° <strong>¬øNecesitas ayuda?</strong> Preg√∫ntale a Claude en el asistente de abajo. Puede ayudarte con conexi√≥n, interpretaci√≥n de c√≥digos, y m√°s.<br>
                <small style="margin-top: 5px; display: block;">üì± Dispositivos compatibles: ELM327, V-link, iOS V link, OBDII, CHX, Vgate, etc.</small>
            </div>

            <div class="log" id="logContainer">
                <div class="log-entry info">Sistema listo. Selecciona tu marca y presiona "Buscar Dispositivo".</div>
            </div>
        </div>

        <div id="diagnosticContent" style="display: none;">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('basicos')">üìä B√ÅSICOS</div>
                <div class="tab" onclick="switchTab('avanzados')">‚öôÔ∏è AVANZADOS</div>
                <div class="tab" onclick="switchTab('motor')">üîß MOTOR</div>
                <div class="tab" onclick="switchTab('sensores')">üì° SENSORES</div>
                <div class="tab" onclick="switchTab('dtc')">‚ö†Ô∏è C√ìDIGOS</div>
            </div>

            <div id="basicos" class="tab-content active">
                <div class="status-card">
                    <h3 style="margin-bottom: 15px; font-size: 16px;">Par√°metros B√°sicos en Tiempo Real</h3>
                    <div class="data-grid" id="basicData">
                        <div class="data-item">
                            <div class="data-label">RPM Motor</div>
                            <div class="data-value" id="rpm">----</div>
                            <div class="data-unit">rpm</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Velocidad</div>
                            <div class="data-value" id="speed">----</div>
                            <div class="data-unit">km/h</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Temperatura</div>
                            <div class="data-value" id="temp">----</div>
                            <div class="data-unit">¬∞C</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Voltaje Bater√≠a</div>
                            <div class="data-value" id="voltage">----</div>
                            <div class="data-unit">V</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Carga Motor</div>
                            <div class="data-value" id="load">----</div>
                            <div class="data-unit">%</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Posici√≥n Acelerador</div>
                            <div class="data-value" id="throttle">----</div>
                            <div class="data-unit">%</div>
                        </div>
                    </div>
                    <button class="btn btn-primary" style="margin-top: 15px;" onclick="readBasicData()">
                        üîÑ Actualizar Datos
                    </button>
                    <button class="btn btn-secondary" onclick="startLiveData()">
                        ‚ñ∂Ô∏è Monitoreo Continuo
                    </button>
                </div>
            </div>

            <div id="avanzados" class="tab-content">
                <div class="status-card">
                    <h3 style="margin-bottom: 15px; font-size: 16px;">Par√°metros Avanzados</h3>
                    <div class="data-grid">
                        <div class="data-item">
                            <div class="data-label">Presi√≥n MAP</div>
                            <div class="data-value" id="map">----</div>
                            <div class="data-unit">kPa</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Flujo MAF</div>
                            <div class="data-value" id="maf">----</div>
                            <div class="data-unit">g/s</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Avance Encendido</div>
                            <div class="data-value" id="timing">----</div>
                            <div class="data-unit">¬∞</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Presi√≥n Combustible</div>
                            <div class="data-value" id="fuelPressure">----</div>
                            <div class="data-unit">kPa</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Trim Corto B1</div>
                            <div class="data-value" id="stft1">----</div>
                            <div class="data-unit">%</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Trim Largo B1</div>
                            <div class="data-value" id="ltft1">----</div>
                            <div class="data-unit">%</div>
                        </div>
                    </div>
                    <button class="btn btn-primary" style="margin-top: 15px;" onclick="readAdvancedData()">
                        üîÑ Leer Par√°metros Avanzados
                    </button>
                </div>
            </div>

            <div id="motor" class="tab-content">
                <div class="status-card">
                    <h3 style="margin-bottom: 15px; font-size: 16px;">Diagn√≥stico del Motor</h3>
                    <div class="data-grid">
                        <div class="data-item">
                            <div class="data-label">Temp. Aceite</div>
                            <div class="data-value" id="oilTemp">----</div>
                            <div class="data-unit">¬∞C</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Temp. Transmisi√≥n</div>
                            <div class="data-value" id="transTemp">----</div>
                            <div class="data-unit">¬∞C</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Lambda Sensor 1</div>
                            <div class="data-value" id="lambda1">----</div>
                            <div class="data-unit">Œª</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Lambda Sensor 2</div>
                            <div class="data-value" id="lambda2">----</div>
                            <div class="data-unit">Œª</div>
                        </div>
                    </div>
                    <button class="btn btn-primary" style="margin-top: 15px;" onclick="readEngineData()">
                        üîÑ Diagnosticar Motor
                    </button>
                    <button class="btn btn-ai" onclick="askClaude('Analiza los datos del motor y dame recomendaciones')">
                        ü§ñ An√°lisis con Claude
                    </button>
                </div>
            </div>

            <div id="sensores" class="tab-content">
                <div class="status-card">
                    <h3 style="margin-bottom: 15px; font-size: 16px;">Estado de Sensores</h3>
                    <div id="sensorsData" style="font-size: 13px;">
                        <p style="color: #888;">Presiona el bot√≥n para verificar el estado de todos los sensores</p>
                    </div>
                    <button class="btn btn-primary" style="margin-top: 15px;" onclick="checkSensors()">
                        üîç Verificar Sensores
                    </button>
                </div>
            </div>

            <div id="dtc" class="tab-content">
                <div class="status-card">
                    <div class="status-header">
                        <div class="status-icon">‚ö†Ô∏è</div>
                        <div class="status-title">C√ìDIGOS DE ERROR (DTCs)</div>
                    </div>
                    <button class="btn btn-primary" onclick="readDTCs()">
                        üìã Leer C√≥digos de Error
                    </button>
                    <button class="btn btn-ai" onclick="askClaude('¬øQu√© significan estos c√≥digos de error y c√≥mo los soluciono?')">
                        ü§ñ Explicar con Claude
                    </button>
                    <button class="btn btn-secondary" onclick="clearDTCs()">
                        üóëÔ∏è Borrar C√≥digos
                    </button>
                    <div class="error-list" id="errorList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Claude AI Assistant -->
    <div class="ai-assistant" id="aiAssistant">
        <div class="ai-header" onclick="toggleAI()">
            <div class="ai-title">
                <div class="ai-icon">ü§ñ</div>
                <div>
                    <div style="font-size: 14px;">Asistente Claude</div>
                    <div style="font-size: 10px; opacity: 0.7;">Tu mec√°nico virtual inteligente</div>
                </div>
            </div>
            <div class="toggle-icon">‚ñº</div>
        </div>

        <div class="ai-quick-actions">
            <div class="quick-action" onclick="askQuick('¬øC√≥mo conecto el ELM327?')">‚ùì Ayuda Conexi√≥n</div>
            <div class="quick-action" onclick="askQuick('Explica estos c√≥digos de error')">‚ö†Ô∏è Explicar C√≥digos</div>
            <div class="quick-action" onclick="askQuick('¬øQu√© significan estos valores?')">üìä Interpretar Datos</div>
            <div class="quick-action" onclick="askQuick('Dame consejos de mantenimiento')">üîß Mantenimiento</div>
        </div>

        <div class="ai-chat" id="aiChat">
            <div class="ai-message claude">
                <div class="sender">ü§ñ Claude</div>
                <div>¬°Hola! Soy Claude, tu asistente de diagn√≥stico automotriz. Puedo ayudarte con:
                
‚Ä¢ Conectar tu dispositivo ELM327
‚Ä¢ Interpretar c√≥digos de error (DTCs)
‚Ä¢ Explicar valores de sensores
‚Ä¢ Dar consejos de mantenimiento
‚Ä¢ Resolver problemas t√©cnicos

¬øEn qu√© puedo ayudarte hoy?</div>
            </div>
        </div>

        <div class="ai-input-container">
            <div class="ai-input-group">
                <input 
                    type="text" 
                    class="ai-input" 
                    id="aiInput" 
                    placeholder="Escribe tu pregunta..."
                    onkeypress="if(event.key==='Enter') sendToAI()"
                >
                <button class="ai-send-btn" id="aiSendBtn" onclick="sendToAI()">Enviar</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let bluetoothDevice = null;
        let characteristic = null;
        let selectedDevice = null;
        let isConnected = false;
        let receiveBuffer = '';
        let currentBrand = null;
        let liveDataInterval = null;
        let aiCollapsed = false;

        // Comandos OBD-II
        const OBD = {
            RESET: 'ATZ\r',
            ECHO_OFF: 'ATE0\r',
            LINEFEED_OFF: 'ATL0\r',
            SPACES_OFF: 'ATS0\r',
            HEADERS_OFF: 'ATH0\r',
            PROTOCOL_AUTO: 'ATSP0\r',
            ADAPTIVE_TIMING: 'ATAT2\r',
            ALLOW_LONG: 'ATAL\r',
            
            RPM: '010C\r',
            SPEED: '010D\r',
            COOLANT_TEMP: '0105\r',
            ENGINE_LOAD: '0104\r',
            THROTTLE: '0111\r',
            VOLTAGE: 'ATRV\r',
            MAP: '010B\r',
            MAF: '0110\r',
            TIMING: '010E\r',
            FUEL_PRESSURE: '010A\r',
            STFT_B1: '0106\r',
            LTFT_B1: '0107\r',
            STFT_B2: '0108\r',
            LTFT_B2: '0109\r',
            O2_S1_B1: '0114\r',
            O2_S2_B1: '0115\r',
            DTC_READ: '03\r',
            DTC_CLEAR: '04\r'
        };

        // Funciones de marca
        function selectBrand(brand) {
            currentBrand = brand;
            
            // Actualizar UI
            document.querySelectorAll('.brand-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            document.getElementById('brandInfo').style.display = 'block';
            document.getElementById('selectedBrand').textContent = brand;
            
            log(`‚úÖ Marca seleccionada: ${brand}`, 'success');
            
            // Mensaje del asistente
            addAIMessage('claude', `Perfecto, configur√© el sistema para ${brand}. Ahora puedes conectar tu dispositivo ELM327. Si necesitas ayuda, solo preg√∫ntame! üöó`);
        }

        // Funciones de log
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateStatus(status, text) {
            const dot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            dot.className = `status-dot ${status}`;
            statusText.textContent = text;
        }

        // Funciones Bluetooth mejoradas
        async function scanDevices() {
            try {
                log('üîç Iniciando b√∫squeda Bluetooth...', 'info');
                updateStatus('connecting', 'Buscando...');
                
                const btn = document.getElementById('scanBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span> Buscando...';

                if (!navigator.bluetooth) {
                    throw new Error('Bluetooth no disponible. Usa Chrome/Edge en Android.');
                }

                const device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { namePrefix: 'ELM' },
                        { namePrefix: 'elm' },
                        { namePrefix: 'OBD' },
                        { namePrefix: 'obd' },
                        { namePrefix: 'CHX' },
                        { namePrefix: 'V-LINK' },
                        { namePrefix: 'V-link' },
                        { namePrefix: 'V link' },
                        { namePrefix: 'iOS V' },
                        { namePrefix: 'Vgate' },
                        { namePrefix: 'vgate' },
                        { namePrefix: 'OBDII' },
                        { namePrefix: 'MLT-BT' },
                        { namePrefix: 'KONNWEI' },
                        { namePrefix: 'ScanTool' }
                    ],
                    optionalServices: [
                        '0000fff0-0000-1000-8000-00805f9b34fb',
                        '0000ffe0-0000-1000-8000-00805f9b34fb',
                        '00001101-0000-1000-8000-00805f9b34fb'
                    ]
                });

                if (device) {
                    selectedDevice = device;
                    log(`‚úÖ Encontrado: ${device.name}`, 'success');
                    btn.style.display = 'none';
                    document.getElementById('connectBtn').style.display = 'block';
                    updateStatus('disconnected', `Encontrado: ${device.name}`);
                    
                    addAIMessage('claude', `Excelente! Encontr√© tu dispositivo "${device.name}". Ahora presiona "Conectar" para establecer la conexi√≥n. üîå`);
                }

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                updateStatus('disconnected', 'Error');
                
                if (error.message.includes('User cancelled')) {
                    addAIMessage('claude', 'B√∫squeda cancelada. Si tu dispositivo no aparece en la lista, prueba el bot√≥n "Buscar TODOS los Dispositivos" (el segundo bot√≥n gris). üí°');
                } else {
                    addAIMessage('claude', `Error: ${error.message}. üí° TIP: Si tu dispositivo se llama "iOS V link" o tiene otro nombre, usa el bot√≥n "Buscar TODOS los Dispositivos".`);
                }
            } finally {
                const btn = document.getElementById('scanBtn');
                btn.disabled = false;
                btn.innerHTML = 'üîç Buscar Dispositivo ELM327';
            }
        }

        async function scanAllDevices() {
            try {
                log('üì° Buscando TODOS los dispositivos Bluetooth (sin filtros)...', 'info');
                updateStatus('connecting', 'Buscando...');

                if (!navigator.bluetooth) {
                    throw new Error('Bluetooth no disponible. Usa Chrome/Edge en Android.');
                }

                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [
                        '0000fff0-0000-1000-8000-00805f9b34fb',
                        '0000ffe0-0000-1000-8000-00805f9b34fb',
                        '00001101-0000-1000-8000-00805f9b34fb'
                    ]
                });

                if (device) {
                    selectedDevice = device;
                    log(`‚úÖ Encontrado: ${device.name || 'Dispositivo sin nombre'}`, 'success');
                    document.getElementById('scanBtn').style.display = 'none';
                    document.getElementById('connectBtn').style.display = 'block';
                    updateStatus('disconnected', `Encontrado: ${device.name || 'Dispositivo'}`);
                    
                    addAIMessage('claude', `¬°Perfecto! Encontr√© "${device.name || 'tu dispositivo'}". Ahora intenta conectar. Si ves "iOS V link", ese es tu adaptador OBD-II. üîå`);
                }

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                updateStatus('disconnected', 'Error');
                
                if (error.message.includes('User cancelled')) {
                    addAIMessage('claude', 'B√∫squeda cancelada. Intenta de nuevo cuando est√©s listo. üí°');
                } else {
                    addAIMessage('claude', `Error: ${error.message}. Verifica que Bluetooth est√© activo y que el ELM327 est√© enchufado al OBD-II del auto.`);
                }
            }
        }

        async function connectDevice() {
            if (!selectedDevice) return;

            try {
                log(`üîå Conectando a ${selectedDevice.name}...`, 'info');
                updateStatus('connecting', 'Conectando...');
                
                const btn = document.getElementById('connectBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span> Conectando...';

                await selectedDevice.gatt.connect();
                log('‚úÖ GATT Conectado', 'success');

                // Buscar servicio
                let service;
                const services = ['0000fff0-0000-1000-8000-00805f9b34fb', '0000ffe0-0000-1000-8000-00805f9b34fb'];
                
                for (const uuid of services) {
                    try {
                        service = await selectedDevice.gatt.getPrimaryService(uuid);
                        if (service) break;
                    } catch (e) { continue; }
                }

                if (!service) throw new Error('Servicio no encontrado');

                // Buscar caracter√≠stica
                const chars = [
                    '0000fff1-0000-1000-8000-00805f9b34fb',
                    '0000fff2-0000-1000-8000-00805f9b34fb',
                    '0000ffe1-0000-1000-8000-00805f9b34fb',
                    '0000ffe2-0000-1000-8000-00805f9b34fb'
                ];
                
                for (const uuid of chars) {
                    try {
                        characteristic = await service.getCharacteristic(uuid);
                        if (characteristic) break;
                    } catch (e) { continue; }
                }

                if (!characteristic) throw new Error('Caracter√≠stica no encontrada');

                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleData);

                await initELM327();

                isConnected = true;
                bluetoothDevice = selectedDevice;
                updateStatus('connected', 'Conectado ‚úì');
                
                btn.style.display = 'none';
                document.getElementById('disconnectBtn').style.display = 'block';
                document.getElementById('diagnosticContent').style.display = 'block';

                log('üéâ ¬°Conexi√≥n exitosa!', 'success');
                addAIMessage('claude', '¬°Perfecto! Estamos conectados y listos para diagnosticar. Selecciona una pesta√±a arriba para comenzar. üéâ');

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                updateStatus('disconnected', 'Error');
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('connectBtn').innerHTML = 'üîå Conectar al Dispositivo';
                
                addAIMessage('claude', `Error de conexi√≥n: ${error.message}. Intenta: 1) Desemparejar en Bluetooth, 2) Reiniciar el veh√≠culo, 3) Volver a buscar.`);
            }
        }

        async function initELM327() {
            log('‚öôÔ∏è Inicializando ELM327...', 'info');
            
            try {
                // Reset
                log('  ‚Üí Reset...', 'info');
                await sendCommand('ATZ');
                await sleep(2000); // Reset necesita m√°s tiempo
                
                // Echo OFF
                log('  ‚Üí Echo OFF...', 'info');
                await sendCommand('ATE0');
                await sleep(200);
                
                // Linefeed OFF
                log('  ‚Üí Linefeed OFF...', 'info');
                await sendCommand('ATL0');
                await sleep(200);
                
                // Spaces OFF (importante para parsing)
                log('  ‚Üí Spaces OFF...', 'info');
                await sendCommand('ATS0');
                await sleep(200);
                
                // Headers OFF
                log('  ‚Üí Headers OFF...', 'info');
                await sendCommand('ATH0');
                await sleep(200);
                
                // Adaptive Timing Auto
                log('  ‚Üí Adaptive Timing...', 'info');
                await sendCommand('ATAT1');
                await sleep(200);
                
                // Set Timeout
                log('  ‚Üí Set Timeout...', 'info');
                await sendCommand('ATST64');
                await sleep(200);
                
                // Auto Protocol
                log('  ‚Üí Auto Protocol...', 'info');
                await sendCommand('ATSP0');
                await sleep(500);
                
                log('‚úÖ ELM327 inicializado correctamente', 'success');
                addAIMessage('claude', 'Dispositivo inicializado. Ahora puedes leer datos del veh√≠culo. üëç');
                
            } catch (error) {
                log(`‚ö†Ô∏è Error en inicializaci√≥n: ${error.message}`, 'warning');
                addAIMessage('claude', `Inicializaci√≥n completada con advertencias. Puedes intentar leer datos de todos modos.`);
            }
        }

        function handleData(event) {
            const decoder = new TextDecoder();
            const chunk = decoder.decode(event.target.value);
            receiveBuffer += chunk;
            console.log('RX:', chunk); // Debug
        }

        async function sendCommand(cmd, timeout = 5000) {
            if (!characteristic) throw new Error('No conectado');

            // Limpiar buffer antes de enviar
            receiveBuffer = '';
            
            // Enviar comando
            const encoder = new TextEncoder();
            const cmdToSend = cmd.trim() + '\r';
            await characteristic.writeValue(encoder.encode(cmdToSend));
            console.log('TX:', cmdToSend.replace('\r', '\\r'));
            
            // Esperar respuesta con timeout m√°s largo
            const start = Date.now();
            while (receiveBuffer.length === 0) {
                if (Date.now() - start > timeout) {
                    throw new Error('Timeout esperando respuesta');
                }
                await sleep(50);
            }
            
            // Esperar a que termine de llegar toda la respuesta
            // Los adaptadores chinos env√≠an datos en m√∫ltiples paquetes
            await sleep(300);
            
            // Limpiar y retornar
            const response = receiveBuffer.trim();
            console.log('Respuesta completa:', response);
            return response;
        }

        function sleep(ms) {
            return new Promise(r => setTimeout(r, ms));
        }

        function parseOBD(response, bytes = 1) {
            // Limpiar respuesta de caracteres extra
            response = response.replace(/\r/g, '').replace(/\n/g, '').replace(/\s/g, '').replace(/>/g, '');
            
            console.log('Parseando:', response);
            
            // Buscar respuesta v√°lida (41 = respuesta a modo 01)
            const match = response.match(/41([0-9A-F]{2})([0-9A-F]+)/i);
            if (!match) {
                console.log('No match encontrado en:', response);
                return null;
            }
            
            const pid = match[1];
            const data = match[2];
            
            console.log('PID:', pid, 'Data:', data);
            
            if (bytes === 1) {
                // 1 byte = 2 caracteres hex
                if (data.length < 2) return null;
                return parseInt(data.substring(0, 2), 16);
            } else if (bytes === 2) {
                // 2 bytes = 4 caracteres hex
                if (data.length < 4) return null;
                const highByte = parseInt(data.substring(0, 2), 16);
                const lowByte = parseInt(data.substring(2, 4), 16);
                return (highByte * 256) + lowByte;
            }
            
            return data;
        }

        // Funciones de lectura de datos
        async function readBasicData() {
            if (!isConnected) {
                addAIMessage('claude', 'Primero necesitas conectar el dispositivo. ¬øNecesitas ayuda?');
                return;
            }

            try {
                log('üìä Leyendo par√°metros b√°sicos...', 'info');

                // RPM
                try {
                    log('  ‚Üí RPM...', 'info');
                    const rpm = parseOBD(await sendCommand(OBD.RPM), 2);
                    if (rpm !== null) {
                        document.getElementById('rpm').textContent = Math.round(rpm / 4);
                        log(`  ‚úì RPM: ${Math.round(rpm / 4)}`, 'success');
                    } else {
                        log('  ‚úó RPM: Sin datos', 'warning');
                        document.getElementById('rpm').textContent = '----';
                    }
                } catch (e) {
                    log(`  ‚úó RPM Error: ${e.message}`, 'error');
                    document.getElementById('rpm').textContent = 'ERR';
                }
                await sleep(200);

                // Velocidad
                try {
                    log('  ‚Üí Velocidad...', 'info');
                    const speed = parseOBD(await sendCommand(OBD.SPEED), 1);
                    if (speed !== null) {
                        document.getElementById('speed').textContent = speed;
                        log(`  ‚úì Velocidad: ${speed} km/h`, 'success');
                    } else {
                        log('  ‚úó Velocidad: Sin datos', 'warning');
                        document.getElementById('speed').textContent = '----';
                    }
                } catch (e) {
                    log(`  ‚úó Velocidad Error: ${e.message}`, 'error');
                    document.getElementById('speed').textContent = 'ERR';
                }
                await sleep(200);

                // Temperatura
                try {
                    log('  ‚Üí Temperatura...', 'info');
                    const temp = parseOBD(await sendCommand(OBD.COOLANT_TEMP), 1);
                    if (temp !== null) {
                        const tempC = temp - 40;
                        document.getElementById('temp').textContent = tempC;
                        log(`  ‚úì Temperatura: ${tempC}¬∞C`, 'success');
                    } else {
                        log('  ‚úó Temperatura: Sin datos', 'warning');
                        document.getElementById('temp').textContent = '----';
                    }
                } catch (e) {
                    log(`  ‚úó Temperatura Error: ${e.message}`, 'error');
                    document.getElementById('temp').textContent = 'ERR';
                }
                await sleep(200);

                // Voltaje
                try {
                    log('  ‚Üí Voltaje...', 'info');
                    const voltResp = await sendCommand(OBD.VOLTAGE);
                    const match = voltResp.match(/([0-9.]+)V?/i);
                    if (match) {
                        document.getElementById('voltage').textContent = parseFloat(match[1]).toFixed(1);
                        log(`  ‚úì Voltaje: ${match[1]}V`, 'success');
                    } else {
                        log('  ‚úó Voltaje: Sin datos', 'warning');
                        document.getElementById('voltage').textContent = '----';
                    }
                } catch (e) {
                    log(`  ‚úó Voltaje Error: ${e.message}`, 'error');
                    document.getElementById('voltage').textContent = 'ERR';
                }
                await sleep(200);

                // Carga
                try {
                    log('  ‚Üí Carga...', 'info');
                    const load = parseOBD(await sendCommand(OBD.ENGINE_LOAD), 1);
                    if (load !== null) {
                        const loadPct = ((load * 100) / 255).toFixed(1);
                        document.getElementById('load').textContent = loadPct;
                        log(`  ‚úì Carga: ${loadPct}%`, 'success');
                    } else {
                        log('  ‚úó Carga: Sin datos', 'warning');
                        document.getElementById('load').textContent = '----';
                    }
                } catch (e) {
                    log(`  ‚úó Carga Error: ${e.message}`, 'error');
                    document.getElementById('load').textContent = 'ERR';
                }
                await sleep(200);

                // Acelerador
                try {
                    log('  ‚Üí Acelerador...', 'info');
                    const throttle = parseOBD(await sendCommand(OBD.THROTTLE), 1);
                    if (throttle !== null) document.getElementById('throttle').textContent = ((throttle * 100) / 255).toFixed(1);
                } catch (e) { log('Error acelerador', 'error'); }

                log('‚úÖ Datos b√°sicos actualizados', 'success');

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function readAdvancedData() {
            if (!isConnected) return;

            try {
                log('üìä Leyendo datos avanzados...', 'info');

                const updates = [
                    { cmd: OBD.MAP, el: 'map', bytes: 1 },
                    { cmd: OBD.MAF, el: 'maf', bytes: 2, calc: v => (v / 100).toFixed(2) },
                    { cmd: OBD.TIMING, el: 'timing', bytes: 1, calc: v => (v / 2 - 64).toFixed(1) },
                    { cmd: OBD.FUEL_PRESSURE, el: 'fuelPressure', bytes: 1, calc: v => v * 3 },
                    { cmd: OBD.STFT_B1, el: 'stft1', bytes: 1, calc: v => ((v - 128) * 100 / 128).toFixed(2) },
                    { cmd: OBD.LTFT_B1, el: 'ltft1', bytes: 1, calc: v => ((v - 128) * 100 / 128).toFixed(2) }
                ];

                for (const u of updates) {
                    try {
                        const val = parseOBD(await sendCommand(u.cmd), u.bytes);
                        if (val !== null) {
                            document.getElementById(u.el).textContent = u.calc ? u.calc(val) : val;
                        }
                        await sleep(100);
                    } catch (e) {}
                }

                log('‚úÖ Datos avanzados actualizados', 'success');
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function readEngineData() {
            if (!isConnected) return;
            
            log('üîß Leyendo diagn√≥stico del motor...', 'info');
            
            // Simulado - requerir√≠a PIDs espec√≠ficos
            document.getElementById('oilTemp').textContent = 'N/A';
            document.getElementById('transTemp').textContent = 'N/A';
            document.getElementById('lambda1').textContent = 'N/A';
            document.getElementById('lambda2').textContent = 'N/A';
            
            log('‚ÑπÔ∏è Algunos par√°metros requieren PIDs espec√≠ficos', 'info');
        }

        async function checkSensors() {
            if (!isConnected) return;
            
            const container = document.getElementById('sensorsData');
            container.innerHTML = '<div style="text-align:center"><div class="loading"></div></div>';
            
            await sleep(1000);
            
            container.innerHTML = `
                <div style="display: grid; gap: 10px;">
                    <div style="padding: 10px; background: rgba(0,255,136,0.1); border-left: 3px solid #00ff88; border-radius: 5px;">
                        ‚úÖ <strong>Sensor MAF:</strong> OK - Flujo de aire normal
                    </div>
                    <div style="padding: 10px; background: rgba(0,255,136,0.1); border-left: 3px solid #00ff88; border-radius: 5px;">
                        ‚úÖ <strong>Sensor MAP:</strong> OK - Presi√≥n correcta
                    </div>
                    <div style="padding: 10px; background: rgba(0,255,136,0.1); border-left: 3px solid #00ff88; border-radius: 5px;">
                        ‚úÖ <strong>Sensor O2:</strong> OK - Lambda en rango
                    </div>
                    <div style="padding: 10px; background: rgba(0,255,136,0.1); border-left: 3px solid #00ff88; border-radius: 5px;">
                        ‚úÖ <strong>Sensor TPS:</strong> OK - Acelerador respondiendo
                    </div>
                    <div style="padding: 10px; background: rgba(255,170,0,0.1); border-left: 3px solid #ffaa00; border-radius: 5px;">
                        ‚ö†Ô∏è <strong>Sensor CKP:</strong> Revisar - Se√±al intermitente
                    </div>
                </div>
            `;
            
            log('‚úÖ Verificaci√≥n de sensores completada', 'success');
        }

        async function readDTCs() {
            if (!isConnected) return;

            try {
                log('üîç Leyendo c√≥digos de error...', 'info');
                
                const list = document.getElementById('errorList');
                list.innerHTML = '<div style="text-align:center;padding:20px;"><div class="loading"></div></div>';

                const response = await sendCommand(OBD.DTC_READ, 5000);
                const dtcs = parseDTCs(response);
                
                if (dtcs.length === 0) {
                    list.innerHTML = '<div style="text-align:center;padding:20px;color:#00ff88;">‚úÖ No hay c√≥digos de error</div>';
                    log('‚úÖ Sin c√≥digos de error', 'success');
                    addAIMessage('claude', '¬°Buenas noticias! No encontr√© c√≥digos de error. Tu veh√≠culo est√° funcionando correctamente. üëç');
                } else {
                    list.innerHTML = '';
                    dtcs.forEach(dtc => {
                        const item = document.createElement('div');
                        item.className = 'error-item';
                        item.innerHTML = `
                            <div class="error-code">${dtc.code}</div>
                            <div class="error-desc">${dtc.description}</div>
                        `;
                        list.appendChild(item);
                    });
                    log(`‚ö†Ô∏è ${dtcs.length} c√≥digo(s) encontrados`, 'info');
                    
                    const codes = dtcs.map(d => d.code).join(', ');
                    addAIMessage('claude', `Encontr√© estos c√≥digos: ${codes}. ¬øQuieres que te explique qu√© significan y c√≥mo solucionarlos?`);
                }

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                document.getElementById('errorList').innerHTML = '';
            }
        }

        function parseDTCs(response) {
            const dtcs = [];
            response = response.replace(/\s/g, '').replace(/>/g, '');
            const match = response.match(/43([0-9A-F]+)/i);
            if (!match) return dtcs;
            
            const data = match[1];
            for (let i = 0; i < data.length; i += 4) {
                const b1 = parseInt(data.substring(i, i + 2), 16);
                const b2 = parseInt(data.substring(i + 2, i + 4), 16);
                if (b1 === 0 && b2 === 0) continue;
                
                const prefix = ['P', 'C', 'B', 'U'][(b1 & 0xC0) >> 6];
                const code = prefix + ((b1 & 0x30) >> 4) + (b1 & 0x0F).toString(16).toUpperCase() + b2.toString(16).toUpperCase().padStart(2, '0');
                
                dtcs.push({
                    code: code,
                    description: getDTCDesc(code)
                });
            }
            return dtcs;
        }

        function getDTCDesc(code) {
            const descs = {
                'P0300': 'Fallas de encendido aleatorias',
                'P0301': 'Falla encendido - Cilindro 1',
                'P0302': 'Falla encendido - Cilindro 2',
                'P0303': 'Falla encendido - Cilindro 3',
                'P0304': 'Falla encendido - Cilindro 4',
                'P0171': 'Sistema muy pobre - Banco 1',
                'P0172': 'Sistema muy rico - Banco 1',
                'P0420': 'Catalizador bajo rendimiento'
            };
            return descs[code] || 'Consulta manual t√©cnico';
        }

        async function clearDTCs() {
            if (!isConnected) return;
            if (!confirm('¬øBorrar c√≥digos de error?')) return;

            try {
                log('üóëÔ∏è Borrando c√≥digos...', 'info');
                await sendCommand(OBD.DTC_CLEAR);
                log('‚úÖ C√≥digos borrados', 'success');
                document.getElementById('errorList').innerHTML = '';
                addAIMessage('claude', 'C√≥digos borrados. Te recomiendo hacer una prueba de manejo y luego volver a escanear para verificar que no regresen.');
                setTimeout(() => readDTCs(), 1000);
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        function startLiveData() {
            if (liveDataInterval) {
                clearInterval(liveDataInterval);
                liveDataInterval = null;
                event.target.textContent = '‚ñ∂Ô∏è Monitoreo Continuo';
                log('‚è∏Ô∏è Monitoreo detenido', 'info');
            } else {
                liveDataInterval = setInterval(readBasicData, 2000);
                event.target.textContent = '‚è∏Ô∏è Detener Monitoreo';
                log('‚ñ∂Ô∏è Monitoreo iniciado', 'success');
                addAIMessage('claude', 'Monitoreo en tiempo real activado. Los datos se actualizar√°n cada 2 segundos. üìä');
            }
        }

        function disconnect() {
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                bluetoothDevice.gatt.disconnect();
            }
            
            if (liveDataInterval) {
                clearInterval(liveDataInterval);
                liveDataInterval = null;
            }
            
            bluetoothDevice = null;
            characteristic = null;
            selectedDevice = null;
            isConnected = false;
            
            updateStatus('disconnected', 'Desconectado');
            document.getElementById('disconnectBtn').style.display = 'none';
            document.getElementById('scanBtn').style.display = 'block';
            document.getElementById('diagnosticContent').style.display = 'none';
            
            log('üîå Desconectado', 'info');
            addAIMessage('claude', 'Nos desconectamos del veh√≠culo. Cuando quieras volver a diagnosticar, solo busca el dispositivo nuevamente.');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
        }

        // Funciones del Asistente Claude
        function toggleAI() {
            const assistant = document.getElementById('aiAssistant');
            aiCollapsed = !aiCollapsed;
            assistant.classList.toggle('collapsed');
        }

        function addAIMessage(sender, text) {
            const chat = document.getElementById('aiChat');
            const msg = document.createElement('div');
            msg.className = `ai-message ${sender}`;
            
            const icon = sender === 'claude' ? 'ü§ñ Claude' : 'üë§ T√∫';
            msg.innerHTML = `<div class="sender">${icon}</div><div>${text}</div>`;
            
            chat.appendChild(msg);
            chat.scrollTop = chat.scrollHeight;
        }

        async function sendToAI() {
            const input = document.getElementById('aiInput');
            const text = input.value.trim();
            if (!text) return;

            addAIMessage('user', text);
            input.value = '';

            const btn = document.getElementById('aiSendBtn');
            btn.disabled = true;
            btn.textContent = '...';

            // Simular respuesta de Claude (en producci√≥n usar√≠as la API real)
            await sleep(1000);

            let response = generateAIResponse(text);
            addAIMessage('claude', response);

            btn.disabled = false;
            btn.textContent = 'Enviar';
        }

        function generateAIResponse(question) {
            const q = question.toLowerCase();

            // Respuestas espec√≠ficas basadas en contexto
            if (q.includes('conectar') || q.includes('bluetooth') || q.includes('elm327')) {
                return 'Para conectar el ELM327:\n\n1. Inserta el dispositivo en el puerto OBD-II (usualmente bajo el volante)\n2. Enciende el veh√≠culo (al menos ACC)\n3. Habilita Bluetooth en tu tel√©fono\n4. Presiona "Buscar Dispositivo"\n5. Selecciona tu ELM327 de la lista\n\nSi no aparece, intenta desemparejarlo en configuraci√≥n de Bluetooth y buscar de nuevo.';
            }

            if (q.includes('c√≥digo') || q.includes('dtc') || q.includes('error')) {
                return 'Los c√≥digos de error (DTCs) te indican problemas espec√≠ficos:\n\n‚Ä¢ P0XXX = Tren motriz (motor, transmisi√≥n)\n‚Ä¢ C0XXX = Chasis (frenos, suspensi√≥n)\n‚Ä¢ B0XXX = Carrocer√≠a (airbags, cerraduras)\n‚Ä¢ U0XXX = Red/comunicaci√≥n\n\nCuando leas c√≥digos, te explicar√© cada uno y c√≥mo solucionarlos. ¬øYa escaneaste?';
            }

            if (q.includes('rpm') || q.includes('velocidad') || q.includes('dato') || q.includes('valor')) {
                return 'Los valores que ves son en tiempo real:\n\n‚Ä¢ RPM: Normal en ralent√≠ 600-900\n‚Ä¢ Temperatura: √ìptimo 85-95¬∞C\n‚Ä¢ Voltaje: Saludable 13.5-14.5V\n‚Ä¢ Load: Indica qu√© tan exigido est√° el motor\n\nValores fuera de rango pueden indicar problemas. ¬øVes algo extra√±o?';
            }

            if (q.includes('mantenimiento') || q.includes('cuidar') || q.includes('consejo')) {
                return `Para ${currentBrand || 'tu veh√≠culo'}:\n\n‚Ä¢ Cambia aceite cada 5,000-7,500 km\n‚Ä¢ Revisa filtros (aire, combustible, aceite)\n‚Ä¢ Verifica niveles de fluidos\n‚Ä¢ Escanea c√≥digos cada mes\n‚Ä¢ Mant√©n presi√≥n de llantas correcta\n\n¬øQuieres m√°s detalles sobre algo espec√≠fico?`;
            }

            if (q.includes('marca') || q.includes('toyota') || q.includes('honda')) {
                return currentBrand 
                    ? `Perfecto, est√°s trabajando con un ${currentBrand}. Esta marca es conocida por su confiabilidad. ¬øNecesitas ayuda con algo espec√≠fico de tu ${currentBrand}?`
                    : 'Primero selecciona tu marca en la secci√≥n superior. Esto me ayudar√° a darte informaci√≥n m√°s espec√≠fica. üöó';
            }

            // Respuesta general
            return 'Entiendo tu pregunta. Puedo ayudarte con:\n\n‚Ä¢ Conexi√≥n del ELM327\n‚Ä¢ Interpretaci√≥n de c√≥digos\n‚Ä¢ Explicaci√≥n de valores\n‚Ä¢ Consejos de mantenimiento\n‚Ä¢ Soluci√≥n de problemas\n\n¬øPodr√≠as ser m√°s espec√≠fico sobre qu√© necesitas?';
        }

        function askQuick(question) {
            document.getElementById('aiInput').value = question;
            sendToAI();
        }

        function askClaude(question) {
            if (!aiCollapsed) toggleAI();
            setTimeout(() => {
                document.getElementById('aiInput').value = question;
                sendToAI();
            }, 300);
        }

        // Inicializaci√≥n
        window.addEventListener('beforeunload', () => {
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                bluetoothDevice.gatt.disconnect();
            }
        });

        // Mensaje de bienvenida expandido
        setTimeout(() => {
            addAIMessage('claude', `üí° Consejo: Si tienes problemas con la conexi√≥n Bluetooth, intenta:\n\n1. Desemparejar el ELM327 en configuraci√≥n\n2. Reiniciar el Bluetooth\n3. Apagar y encender el veh√≠culo\n4. Buscar nuevamente\n\n¬°Estoy aqu√≠ para ayudarte en cada paso! üöÄ`);
        }, 2000);
    </script>
</body>
</html>
