<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProPart - Sistema Completo con Base de Datos</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 15px;
        }
        .tabs {
            display: flex;
            background: white;
            border-radius: 15px 15px 0 0;
            overflow-x: auto;
        }
        .tab {
            flex: 1;
            min-width: 80px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            background: white;
            border: none;
            font-size: 0.8em;
            font-weight: bold;
            color: #666;
        }
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .tab-content {
            background: white;
            border-radius: 0 0 15px 15px;
            padding: 25px;
            display: none;
            min-height: 500px;
        }
        .tab-content.active { display: block; }
        .status-box {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.3em;
            font-weight: bold;
            margin: 20px 0;
            border-left: 5px solid #667eea;
        }
        .status-box.connected {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }
        .sensor-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #667eea;
        }
        .sensor-card h3 {
            font-size: 0.85em;
            color: #667eea;
            margin-bottom: 6px;
        }
        .sensor-value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
            margin: 6px 0;
        }
        .search-box {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            border: 3px solid #667eea;
            border-radius: 10px;
            margin: 15px 0;
        }
        .quick-btn {
            padding: 10px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            font-size: 0.9em;
        }
        .pinout-result {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .pin-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .pin-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
        }
        .pin-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #ddd;
        }
        .pin-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        .wire-color {
            display: inline-block;
            width: 50px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid #333;
            vertical-align: middle;
            margin-right: 8px;
        }
        .dtc-item {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 5px solid #f44336;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .dtc-code {
            font-size: 1.5em;
            font-weight: bold;
            color: #f44336;
            margin-bottom: 10px;
        }
        button {
            padding: 12px 20px;
            font-size: 1em;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
        }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        .hidden { display: none !important; }
        @media (max-width: 768px) {
            .sensor-grid {
                grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚ö° PROPART DIAGNOSTIC PRO</h1>
        <p>Sistema Completo Multimarca - Fernando Mill√°n</p>
        <p style="font-size: 0.9em;">777 683 8196 | 221 956 7392</p>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('scanner')">üì° SCANNER</button>
            <button class="tab" onclick="switchTab('sensores')">üìä SENSORES</button>
            <button class="tab" onclick="switchTab('database')">üîç BASE DATOS</button>
            <button class="tab" onclick="switchTab('pinouts')">üìç PINOUTS</button>
            <button class="tab" onclick="switchTab('dtc')">‚ö†Ô∏è C√ìDIGOS</button>
        </div>

        <!-- TAB: SCANNER -->
        <div id="tab-scanner" class="tab-content active">
            <h2 style="color: #667eea; margin-bottom: 20px;">üì° Scanner OBD2</h2>
            <div class="status-box" id="status">üî¥ DESCONECTADO</div>
            <div style="text-align: center;">
                <button class="btn-primary" id="btnConnect" style="font-size: 1.2em; padding: 15px 30px;">üîç CONECTAR</button>
                <button class="btn-danger" id="btnDisconnect" style="display: none;">‚ùå DESCONECTAR</button>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn-warning" id="btnDTC" style="display: none;">üìã LEER C√ìDIGOS</button>
                <button class="btn-warning" id="btnClearDTC" style="display: none;">üóëÔ∏è BORRAR C√ìDIGOS</button>
            </div>
            <div id="dtcResult" style="display: none; margin-top: 20px;">
                <h3 style="color: #ff9800; margin-bottom: 15px;">üìã C√≥digos Detectados</h3>
                <div id="dtcList"></div>
            </div>
        </div>

        <!-- TAB: SENSORES -->
        <div id="tab-sensores" class="tab-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">üìä Sensores en Tiempo Real</h2>
            <div class="sensor-grid">
                <div class="sensor-card"><h3>üîÑ RPM</h3><div class="sensor-value" id="rpm">----</div><span>rpm</span></div>
                <div class="sensor-card"><h3>üöó Velocidad</h3><div class="sensor-value" id="speed">----</div><span>km/h</span></div>
                <div class="sensor-card"><h3>üå°Ô∏è Temp Motor</h3><div class="sensor-value" id="temp">----</div><span>¬∞C</span></div>
                <div class="sensor-card"><h3>‚ùÑÔ∏è Temp Aire</h3><div class="sensor-value" id="iat">----</div><span>¬∞C</span></div>
                <div class="sensor-card"><h3>‚ö° Voltaje</h3><div class="sensor-value" id="voltage">----</div><span>V</span></div>
                <div class="sensor-card"><h3>üí™ Carga</h3><div class="sensor-value" id="load">----</div><span>%</span></div>
                <div class="sensor-card"><h3>üéØ TPS</h3><div class="sensor-value" id="tps">----</div><span>%</span></div>
                <div class="sensor-card"><h3>üìä MAP</h3><div class="sensor-value" id="map">----</div><span>kPa</span></div>
                <div class="sensor-card"><h3>üí® MAF</h3><div class="sensor-value" id="maf">----</div><span>g/s</span></div>
                <div class="sensor-card"><h3>üîß STFT</h3><div class="sensor-value" id="stft">----</div><span>%</span></div>
                <div class="sensor-card"><h3>üîß LTFT</h3><div class="sensor-value" id="ltft">----</div><span>%</span></div>
                <div class="sensor-card"><h3>üåä O2</h3><div class="sensor-value" id="o2">----</div><span>V</span></div>
            </div>
        </div>

        <!-- TAB: BASE DE DATOS -->
        <div id="tab-database" class="tab-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">üîç Base de Datos T√©cnica</h2>
            <p style="color: #666; margin-bottom: 15px;">Busca informaci√≥n t√©cnica de sensores, ECU, diagramas...</p>
            
            <input type="text" class="search-box" id="searchDatabase" 
                   placeholder="üîç Ejemplo: MAF Chevy 2007, TPS Tsuru, ECU Jetta..."
                   onkeyup="if(event.key==='Enter')searchDB()">
            
            <div style="margin: 20px 0;">
                <h3 style="color: #667eea; margin-bottom: 10px;">B√∫squedas R√°pidas:</h3>
                <button class="quick-btn" onclick="quickSearchDB('maf chevy 2007')">MAF Chevy 2007</button>
                <button class="quick-btn" onclick="quickSearchDB('tps tsuru')">TPS Tsuru</button>
                <button class="quick-btn" onclick="quickSearchDB('maf tsuru')">MAF Tsuru</button>
                <button class="quick-btn" onclick="quickSearchDB('ecu jetta')">ECU Jetta 121p</button>
                <button class="quick-btn" onclick="quickSearchDB('o2 sensor')">Sensor O2</button>
                <button class="quick-btn" onclick="quickSearchDB('ckp')">CKP</button>
                <button class="quick-btn" onclick="quickSearchDB('map')">MAP</button>
            </div>
            
            <div id="dbResults"></div>
        </div>

        <!-- TAB: PINOUTS -->
        <div id="tab-pinouts" class="tab-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">üìç Pinouts de Sensores y ECU</h2>
            <p style="color: #666; margin-bottom: 15px;">Selecciona marca y modelo para ver pinouts</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
                <select id="pinout-brand" onchange="updatePinoutModels()" style="padding: 12px; font-size: 1em; border: 2px solid #667eea; border-radius: 8px;">
                    <option value="">-- Selecciona Marca --</option>
                    <option value="nissan">Nissan</option>
                    <option value="chevrolet">Chevrolet</option>
                    <option value="vw">Volkswagen</option>
                    <option value="ford">Ford</option>
                    <option value="toyota">Toyota</option>
                    <option value="honda">Honda</option>
                </select>
                
                <select id="pinout-model" style="padding: 12px; font-size: 1em; border: 2px solid #667eea; border-radius: 8px;">
                    <option value="">-- Selecciona Modelo --</option>
                </select>
            </div>
            
            <button class="btn-primary" onclick="showPinouts()" style="width: 100%; padding: 15px; font-size: 1.1em;">
                üìç VER PINOUTS DISPONIBLES
            </button>
            
            <div id="pinoutResults"></div>
        </div>

        <!-- TAB: C√ìDIGOS DTC -->
        <div id="tab-dtc" class="tab-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">‚ö†Ô∏è Base de Datos de C√≥digos DTC</h2>
            
            <input type="text" class="search-box" id="searchDTC" 
                   placeholder="üîç Buscar c√≥digo: P0141, P0036, C0XXX..."
                   onkeyup="if(event.key==='Enter')searchDTCCode()">
            
            <div style="margin: 20px 0;">
                <button class="quick-btn" onclick="searchDTCCode('P0141')">P0141</button>
                <button class="quick-btn" onclick="searchDTCCode('P0036')">P0036</button>
                <button class="quick-btn" onclick="searchDTCCode('P0606')">P0606</button>
                <button class="quick-btn" onclick="searchDTCCode('P0501')">P0501</button>
                <button class="quick-btn" onclick="searchDTCCode('P0171')">P0171</button>
                <button class="quick-btn" onclick="searchDTCCode('P0300')">P0300</button>
            </div>
            
            <div id="dtcCodeResults"></div>
        </div>
    </div>

    <script>
        // ========== BASE DE DATOS COMPLETA MULTIMARCA ==========
        const TECHNICAL_DATABASE = {
            // CHEVROLET - MAF
            'maf_chevy_2007': {
                name: 'Sensor MAF (Mass Air Flow)',
                brand: 'Chevrolet',
                models: 'Aveo, Optra 2007-2011',
                engine: '1.6L DOHC',
                partNumber: '96481558',
                pins: 5,
                pinout: [
                    {pin: 1, function: 'Se√±al MAF', color: 'AMARILLO', colorHex: '#FFD700', voltage: '0.5-5V', normal: '1.0-1.5V ralent√≠, 3.5-4.5V @ 3000 RPM'},
                    {pin: 2, function: 'Tierra sensor', color: 'NEGRO', colorHex: '#000000', voltage: '0V', normal: 'Continuidad <5 Ohms'},
                    {pin: 3, function: 'Alimentaci√≥n 12V', color: 'ROJO', colorHex: '#FF0000', voltage: '12V', normal: '11-14V con switch ON'},
                    {pin: 4, function: 'Se√±al IAT', color: 'VERDE', colorHex: '#00FF00', voltage: '0.5-4.5V', normal: '2.5V @ 20¬∞C'},
                    {pin: 5, function: 'Tierra IAT', color: 'CAFE', colorHex: '#8B4513', voltage: '0V', normal: 'Continuidad <5 Ohms'}
                ],
                test: 'Con motor apagado, llave ON: Pin 3 = 12V. Con motor en ralent√≠: Pin 1 = 1.0-1.5V. A 3000 RPM: Pin 1 = 3.5-4.5V.',
                location: 'Entre filtro de aire y cuerpo de aceleraci√≥n'
            },
            
            // NISSAN - MAF
            'maf_tsuru': {
                name: 'Sensor MAF',
                brand: 'Nissan',
                models: 'Tsuru III 2004-2012',
                engine: 'GA16DE 1.6L 16V',
                partNumber: '22680-4M500',
                pins: 4,
                pinout: [
                    {pin: 1, function: 'Alimentaci√≥n 12V', color: 'ROJO/BLANCO', colorHex: '#FF69B4', voltage: '12V', normal: '12V con switch ON'},
                    {pin: 2, function: 'Se√±al MAF', color: 'VERDE/NEGRO', colorHex: '#90EE90', voltage: '0-5V', normal: '1.2V ralent√≠, 4V @ 3000 RPM'},
                    {pin: 3, function: 'Tierra', color: 'NEGRO', colorHex: '#000000', voltage: '0V', normal: 'Continuidad'},
                    {pin: 4, function: 'Se√±al IAT', color: 'AMARILLO', colorHex: '#FFFF00', voltage: '0.5-4V', normal: '2.0V @ 25¬∞C'}
                ],
                test: 'Llave ON: Pin 1 = 12V. Motor ralent√≠: Pin 2 = 1.0-1.5V. Acelerar: debe subir suavemente a 4V.',
                location: 'Despu√©s del filtro de aire, antes del plenum'
            },
            
            // NISSAN - TPS
            'tps_tsuru': {
                name: 'TPS (Throttle Position Sensor)',
                brand: 'Nissan',
                models: 'Tsuru III 1992-2017',
                engine: 'GA16DE',
                partNumber: '22620-1E400',
                pins: 3,
                pinout: [
                    {pin: 1, function: 'Tierra', color: 'NEGRO', colorHex: '#000000', voltage: '0V', normal: 'Continuidad'},
                    {pin: 2, function: 'Se√±al TPS', color: 'AZUL', colorHex: '#0000FF', voltage: '0.5-4.5V', normal: '0.5V cerrado, 4.5V abierto'},
                    {pin: 3, function: 'Alimentaci√≥n 5V', color: 'ROJO', colorHex: '#FF0000', voltage: '5V', normal: '5V ¬± 0.2V'}
                ],
                test: 'Acelerador cerrado: Pin 2 = 0.5V. Acelerador abierto (WOT): Pin 2 = 4.5V. Debe variar suavemente.',
                location: 'Lado derecho del cuerpo de aceleraci√≥n'
            },
            
            // VW - ECU
            'ecu_jetta_a4': {
                name: 'ECU Bosch Motronic ME7.5',
                brand: 'Volkswagen',
                models: 'Jetta A4, Golf A4 1999-2007',
                engine: '2.0L AEG',
                partNumber: '06A 906 032',
                pins: 121,
                connector: 'Dual: 80 pines + 41 pines',
                pinout: [
                    {pin: 1, function: 'KL15 Ignici√≥n', color: 'ROJO', colorHex: '#FF0000', voltage: '12V', normal: '12V con contacto'},
                    {pin: 2, function: 'KL30 Bater√≠a', color: 'ROJO GRUESO', colorHex: '#8B0000', voltage: '12V', normal: '12V permanente'},
                    {pin: 3, function: 'Tierra 1', color: 'CAFE', colorHex: '#8B4513', voltage: '0V', normal: 'Continuidad'},
                    {pin: 4, function: 'Tierra 2', color: 'CAFE', colorHex: '#8B4513', voltage: '0V', normal: 'Continuidad'},
                    {pin: 10, function: 'Sensor G28 CKP+', color: 'VERDE/NEGRO', colorHex: '#006400', voltage: 'AC', normal: '0.5-2V AC'},
                    {pin: 11, function: 'Sensor G28 CKP-', color: 'VERDE/BLANCO', colorHex: '#90EE90', voltage: 'AC', normal: '0.5-2V AC'}
                ],
                test: 'Verificar tierra en pines 3,4,5. KL30 = 12V permanente. KL15 = 12V con contacto. Sensor G28 debe dar se√±al AC.',
                location: 'Debajo del parabrisas, lado conductor'
            }
        };

        // BASE C√ìDIGOS DTC
        const DTC_DATABASE = {
            'P0036': {desc: 'Sensor O2 calentador B1S2 - Circuito', solution: '1. Verificar cables del sensor O2\n2. Medir resistencia calentador (5-20Œ©)\n3. Revisar fusible\n4. Reemplazar sensor O2', sistemas: 'Sistema de escape, sensores O2'},
            'P0141': {desc: 'Sensor O2 calentador B1S2 - Mal funcionamiento', solution: '1. Verificar conexi√≥n el√©ctrica\n2. Probar voltaje calentador (12V)\n3. Medir resistencia\n4. Reemplazar sensor O2 Bank 1 Sensor 2', sistemas: 'Sistema de escape'},
            'P0501': {desc: 'Sensor de velocidad VSS - Rango/rendimiento', solution: '1. Verificar sensor VSS en transmisi√≥n\n2. Revisar cables y conectores\n3. Limpiar sensor magn√©tico\n4. Verificar engranaje impulsor\n5. Reemplazar VSS', sistemas: 'Sistema de veloc√≠metro, transmisi√≥n'},
            'P0606': {desc: 'ECM/PCM - Error de procesador', solution: '1. Verificar voltaje bater√≠a (12-14V)\n2. Revisar tierras de ECU\n3. Actualizar firmware ECU\n4. Reemplazar ECU (GRAVE)', sistemas: 'Computadora motor'},
            'P0100': {desc: 'MAF - Circuito mal funcionamiento', solution: 'Verificar cables MAF, limpiar sensor, verificar voltaje alimentaci√≥n', sistemas: 'Sistema de admisi√≥n'},
            'P0101': {desc: 'MAF - Rango/rendimiento', solution: 'Limpiar MAF con limpiador espec√≠fico, verificar fugas aire, reemplazar si falla', sistemas: 'Sistema de admisi√≥n'},
            'P0102': {desc: 'MAF - Voltaje bajo', solution: 'Verificar conexi√≥n, cables rotos, cortocircuito a tierra', sistemas: 'Sistema de admisi√≥n'},
            'P0103': {desc: 'MAF - Voltaje alto', solution: 'Verificar cortocircuito a 12V, sensor da√±ado', sistemas: 'Sistema de admisi√≥n'},
            'P0171': {desc: 'Sistema muy pobre Bank 1', solution: 'Revisar fugas vac√≠o, MAF sucio, inyectores, presi√≥n combustible, sensor O2', sistemas: 'Sistema de combustible'},
            'P0172': {desc: 'Sistema muy rico Bank 1', solution: 'Revisar inyectores con fuga, MAF sucio, presi√≥n combustible alta, sensor O2', sistemas: 'Sistema de combustible'},
            'P0300': {desc: 'Fallas encendido aleatorias', solution: 'Revisar buj√≠as, bobinas, compresi√≥n, inyectores, presi√≥n combustible', sistemas: 'Sistema de encendido'},
            'P0301': {desc: 'Falla encendido cilindro 1', solution: 'Verificar buj√≠a cil. 1, bobina, cable, inyector, compresi√≥n', sistemas: 'Sistema de encendido'},
            'P0420': {desc: 'Catalizador eficiencia baja Bank 1', solution: 'Verificar sensores O2, reemplazar catalizador si falla', sistemas: 'Sistema de escape'},
            'P0122': {desc: 'TPS - Voltaje bajo circuito A', solution: 'Verificar voltaje referencia 5V, conexi√≥n a tierra, cables rotos', sistemas: 'Sistema acelerador'},
            'P0123': {desc: 'TPS - Voltaje alto circuito A', solution: 'Verificar cortocircuito a 5V, ajustar o reemplazar TPS', sistemas: 'Sistema acelerador'},
            'P0335': {desc: 'Sensor posici√≥n cig√ºe√±al CKP - Circuito', solution: 'Verificar sensor CKP, cables, distancia al volante (0.5-1.5mm)', sistemas: 'Sistema de encendido'},
            'P0340': {desc: 'Sensor posici√≥n √°rbol levas CMP - Circuito', solution: 'Verificar sensor CMP, cables, sincronizaci√≥n', sistemas: 'Sistema de encendido'}
        };

        // MODELOS POR MARCA
        const MODELS_BY_BRAND = {
            nissan: ['Tsuru III', 'Sentra B13', 'Sentra B14', 'Sentra B15', 'Platina', 'Tiida', 'Versa'],
            chevrolet: ['Chevy C2', 'Aveo', 'Spark', 'Astra', 'Meriva', 'Optra'],
            vw: ['Jetta A4', 'Golf A4', 'Pointer', 'Beetle', 'Polo', 'Bora'],
            ford: ['Focus', 'Fiesta', 'Ikon', 'Escort', 'Fusion'],
            toyota: ['Corolla', 'Yaris', 'Camry', 'Sienna'],
            honda: ['Civic', 'Accord', 'Fit', 'CR-V']
        };

        // ========== BLUETOOTH ==========
        const UUIDS = ['000018f0-0000-1000-8000-00805f9b34fb', '0000fff0-0000-1000-8000-00805f9b34fb'];
        let service, writeChar, notifyChar, loop;
        let receivedData = '';
        let waitingForDTC = false;

        document.getElementById('btnConnect').addEventListener('click', async () => {
            try {
                document.getElementById('status').innerText = "üîç Buscando...";
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: UUIDS
                });
                const server = await device.gatt.connect();
                for (let uuid of UUIDS) {
                    try { service = await server.getPrimaryService(uuid); break; } catch(e) {}
                }
                const characteristics = await service.getCharacteristics();
                for (let char of characteristics) {
                    if (char.properties.write) writeChar = char;
                    if (char.properties.notify) notifyChar = char;
                }
                await notifyChar.startNotifications();
                notifyChar.addEventListener('characteristicvaluechanged', handleData);
                
                document.getElementById('status').innerText = "‚úÖ CONECTADO";
                document.getElementById('status').classList.add('connected');
                document.getElementById('btnConnect').style.display = 'none';
                document.getElementById('btnDisconnect').style.display = 'inline-block';
                document.getElementById('btnDTC').style.display = 'inline-block';
                document.getElementById('btnClearDTC').style.display = 'inline-block';
                
                await send("AT Z"); await wait(1500);
                await send("AT E0"); await wait(300);
                await send("AT SP0"); await wait(500);
                startLoop();
            } catch(error) {
                alert('Error: ' + error.message);
            }
        });

        document.getElementById('btnDisconnect').addEventListener('click', () => {
            if (loop) clearInterval(loop);
            document.getElementById('status').innerText = "üî¥ DESCONECTADO";
            document.getElementById('status').classList.remove('connected');
            document.getElementById('btnConnect').style.display = 'inline-block';
            document.getElementById('btnDisconnect').style.display = 'none';
            document.getElementById('btnDTC').style.display = 'none';
            document.getElementById('btnClearDTC').style.display = 'none';
        });

        document.getElementById('btnDTC').addEventListener('click', async () => {
            if (loop) clearInterval(loop);
            receivedData = '';
            waitingForDTC = true;
            document.getElementById('dtcResult').style.display = 'block';
            document.getElementById('dtcList').innerHTML = '<p style="text-align:center; padding:20px;">‚è≥ ESCANEANDO...</p>';
            await send("03"); await wait(1000);
            await send("03 01"); await wait(1000);
            await send("03 02"); await wait(1000);
            setTimeout(() => {
                waitingForDTC = false;
                displayDTC();
                setTimeout(() => startLoop(), 2000);
            }, 1000);
        });

        function displayDTC() {
            const codes = new Set();
            const matches = receivedData.match(/[PCBU][0-9A-F]{4}/gi);
            if (matches) matches.forEach(c => codes.add(c.toUpperCase()));
            
            const hexPattern = /43[\s]+((?:[0-9A-F]{2}[\s]*)+)/gi;
            const hexMatches = [...receivedData.matchAll(hexPattern)];
            for (let match of hexMatches) {
                const hex = match[1].replace(/\s/g, '');
                for (let i = 0; i < hex.length; i += 4) {
                    const chunk = hex.substring(i, i + 4);
                    if (chunk !== '0000' && chunk.length === 4) {
                        const dtc = hexToDTC(chunk);
                        if (dtc) codes.add(dtc);
                    }
                }
            }
            
            const listEl = document.getElementById('dtcList');
            if (codes.size === 0) {
                listEl.innerHTML = '<p style="text-align:center; padding:40px; font-size:1.2em;">‚úÖ SIN C√ìDIGOS DE FALLA</p>';
            } else {
                listEl.innerHTML = Array.from(codes).map(code => {
                    const info = DTC_DATABASE[code] || {desc: 'C√≥digo gen√©rico', solution: 'Consultar manual', sistemas: 'N/A'};
                    return `
                        <div class="dtc-item">
                            <div class="dtc-code">‚ùå ${code}</div>
                            <div style="font-size:1.1em; margin:10px 0;">${info.desc}</div>
                            <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin-top:10px;">
                                <strong>üîß Soluci√≥n:</strong><br>${info.solution.split('\n').join('<br>')}
                            </div>
                            <div style="margin-top:10px; color:#666;"><strong>Sistema:</strong> ${info.sistemas}</div>
                        </div>
                    `;
                }).join('');
            }
        }

        function hexToDTC(hex) {
            const firstDigit = parseInt(hex[0], 16);
            const prefixes = ['P0','P1','P2','P3','C0','C1','C2','C3','B0','B1','B2','B3','U0','U1','U2','U3'];
            return prefixes[firstDigit] + hex.substring(1);
        }

        document.getElementById('btnClearDTC').addEventListener('click', async () => {
            if (confirm('¬øBorrar c√≥digos?')) {
                if (loop) clearInterval(loop);
                await send("04");
                document.getElementById('dtcResult').style.display = 'none';
                alert('‚úÖ C√≥digos borrados');
                await wait(500);
                startLoop();
            }
        });

        async function send(cmd) {
            if (!writeChar) return;
            await writeChar.writeValue(new TextEncoder().encode(cmd + "\r"));
        }

        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function handleData(event) {
            const value = new TextDecoder().decode(event.target.value).trim();
            if (!value || value === '>') return;
            
            if (waitingForDTC) {
                receivedData += value + ' ';
                return;
            }
            
            // Actualizar sensores
            if (value.includes('41 0C')) {
                const hex = value.replace(/\s/g, '').substring(4, 8);
                if (hex.length === 4) document.getElementById('rpm').textContent = Math.round(parseInt(hex, 16) / 4);
            }
            if (value.includes('41 0D')) {
                const hex = value.replace(/\s/g, '').substring(4, 6);
                if (hex.length === 2) document.getElementById('speed').textContent = parseInt(hex, 16);
            }
            if (value.includes('41 05')) {
                const hex = value.replace(/\s/g, '').substring(4, 6);
                if (hex.length === 2) document.getElementById('temp').textContent = parseInt(hex, 16) - 40;
            }
            if (value.includes('41 0F')) {
                const hex = value.replace(/\s/g, '').substring(4, 6);
                if (hex.length === 2) document.getElementById('iat').textContent = parseInt(hex, 16) - 40;
            }
            if (value.includes('V')) {
                const match = value.match(/(\d+\.?\d*)/);
                if (match) document.getElementById('voltage').textContent = parseFloat(match[1]).toFixed(1);
            }
            if (value.includes('41 04')) {
                const hex = value.replace(/\s/g, '').substring(4, 6);
                if (hex.length === 2) document.getElementById('load').textContent = Math.round((parseInt(hex, 16) * 100) / 255);
            }
            if (value.includes('41 11')) {
                const hex = value.replace(/\s/g, '').substring(4, 6);
                if (hex.length === 2) document.getElementById('tps').textContent = Math.round((parseInt(hex, 16) * 100) / 255);
            }
            if (value.includes('41 0B')) {
                const hex = value.replace(/\s/g, '').substring(4, 6);
                if (hex.length === 2) document.getElementById('map').textContent = parseInt(hex, 16);
            }
            if (value.includes('41 10')) {
                const hex = value.replace(/\s/g, '').substring(4, 8);
                if (hex.length === 4) document.getElementById('maf').textContent = (parseInt(hex, 16) / 100).toFixed(1);
            }
            if (value.includes('41 06')) {
                const hex = value.replace(/\s/g, '').substring(4, 6);
                if (hex.length === 2) document.getElementById('stft').textContent = ((parseInt(hex, 16) - 128) * 100 / 128).toFixed(1);
            }
            if (value.includes('41 07')) {
                const hex = value.replace(/\s/g, '').substring(4, 6);
                if (hex.length === 2) document.getElementById('ltft').textContent = ((parseInt(hex, 16) - 128) * 100 / 128).toFixed(1);
            }
            if (value.includes('41 14')) {
                const hex = value.replace(/\s/g, '').substring(4, 6);
                if (hex.length === 2) document.getElementById('o2').textContent = (parseInt(hex, 16) / 200).toFixed(2);
            }
        }

        function startLoop() {
            loop = setInterval(async () => {
                await send("010C"); await wait(80);
                await send("010D"); await wait(80);
                await send("0105"); await wait(80);
                await send("010F"); await wait(80);
                await send("0104"); await wait(80);
                await send("0111"); await wait(80);
                await send("010B"); await wait(80);
                await send("0110"); await wait(80);
                await send("0106"); await wait(80);
                await send("0107"); await wait(80);
                await send("0114"); await wait(80);
                await send("ATRV");
            }, 2000);
        }

        // ========== BASE DE DATOS ==========
        function searchDB() {
            const query = document.getElementById('searchDatabase').value;
            quickSearchDB(query);
        }

        function quickSearchDB(query) {
            document.getElementById('searchDatabase').value = query;
            const q = query.toLowerCase();
            let found = null;
            
            for (let key in TECHNICAL_DATABASE) {
                const item = TECHNICAL_DATABASE[key];
                const searchText = `${item.name} ${item.brand} ${item.models} ${key}`.toLowerCase();
                if (searchText.includes(q)) {
                    found = item;
                    break;
                }
            }
            
            if (found) {
                displayDBResult(found);
            } else {
                document.getElementById('dbResults').innerHTML = '<div class="pinout-result"><p style="text-align:center; padding:40px;">‚ùå No se encontr√≥ informaci√≥n para: ' + query + '</p></div>';
            }
        }

        function displayDBResult(data) {
            let html = `
                <div class="pinout-result">
                    <h2 style="color:#667eea; margin-bottom:15px;">${data.name}</h2>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:10px; margin:15px 0; padding:15px; background:#f9f9f9; border-radius:8px;">
                        <div><strong>Marca:</strong> ${data.brand}</div>
                        <div><strong>Modelos:</strong> ${data.models}</div>
                        <div><strong>Motor:</strong> ${data.engine || 'N/A'}</div>
                        <div><strong>Parte #:</strong> ${data.partNumber || 'N/A'}</div>
                        <div><strong>Pines:</strong> ${data.pins || data.pinout.length}</div>
                        <div><strong>Ubicaci√≥n:</strong> ${data.location || 'N/A'}</div>
                    </div>
                    
                    <h3 style="color:#667eea; margin:20px 0 10px 0;">üìç Pinout</h3>
                    <table class="pin-table">
                        <thead>
                            <tr>
                                <th>Pin</th>
                                <th>Funci√≥n</th>
                                <th>Color</th>
                                <th>Voltaje</th>
                                <th>Normal</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.pinout.forEach(pin => {
                html += `
                    <tr>
                        <td><strong>${pin.pin}</strong></td>
                        <td>${pin.function}</td>
                        <td><span class="wire-color" style="background:${pin.colorHex};"></span>${pin.color}</td>
                        <td>${pin.voltage}</td>
                        <td>${pin.normal}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                    
                    <div style="background:#e8f5e9; padding:20px; border-radius:10px; margin-top:20px; border-left:5px solid #4CAF50;">
                        <h3 style="color:#4CAF50; margin-bottom:15px;">üîß Procedimiento de Prueba</h3>
                        <pre style="white-space:pre-wrap; font-family:inherit;">${data.test}</pre>
                    </div>
                </div>
            `;
            
            document.getElementById('dbResults').innerHTML = html;
        }

        // ========== PINOUTS POR MARCA/MODELO ==========
        function updatePinoutModels() {
            const brand = document.getElementById('pinout-brand').value;
            const modelSelect = document.getElementById('pinout-model');
            modelSelect.innerHTML = '<option value="">-- Selecciona Modelo --</option>';
            
            if (brand && MODELS_BY_BRAND[brand]) {
                MODELS_BY_BRAND[brand].forEach(model => {
                    modelSelect.innerHTML += `<option value="${model}">${model}</option>`;
                });
            }
        }

        function showPinouts() {
            const brand = document.getElementById('pinout-brand').value;
            const model = document.getElementById('pinout-model').value;
            
            if (!brand) {
                alert('Selecciona una marca');
                return;
            }
            
            let html = '<div class="pinout-result"><h3 style="color:#667eea; margin-bottom:20px;">üìç Pinouts Disponibles</h3>';
            let found = false;
            
            for (let key in TECHNICAL_DATABASE) {
                const item = TECHNICAL_DATABASE[key];
                if (item.brand.toLowerCase() === brand.toLowerCase()) {
                    if (!model || item.models.toLowerCase().includes(model.toLowerCase())) {
                        found = true;
                        html += `
                            <div style="background:#f9f9f9; padding:15px; margin:10px 0; border-radius:8px; cursor:pointer;" onclick="quickSearchDB('${item.name} ${item.brand}')">
                                <strong>${item.name}</strong><br>
                                <span style="color:#666; font-size:0.9em;">${item.models}</span>
                            </div>
                        `;
                    }
                }
            }
            
            if (!found) {
                html += '<p style="text-align:center; padding:20px;">No hay pinouts disponibles para esta selecci√≥n</p>';
            }
            
            html += '</div>';
            document.getElementById('pinoutResults').innerHTML = html;
        }

        // ========== B√öSQUEDA DTC ==========
        function searchDTCCode(code) {
            if (!code) code = document.getElementById('searchDTC').value;
            document.getElementById('searchDTC').value = code;
            
            code = code.toUpperCase().trim();
            const info = DTC_DATABASE[code];
            
            if (info) {
                document.getElementById('dtcCodeResults').innerHTML = `
                    <div class="dtc-item">
                        <div class="dtc-code">${code}</div>
                        <div style="font-size:1.2em; margin:15px 0;"><strong>Descripci√≥n:</strong> ${info.desc}</div>
                        <div style="background:#f9f9f9; padding:20px; border-radius:10px; margin:15px 0;">
                            <h4 style="color:#667eea; margin-bottom:10px;">üîß Soluci√≥n:</h4>
                            <pre style="white-space:pre-wrap; font-family:inherit;">${info.solution}</pre>
                        </div>
                        <div style="background:#e3f2fd; padding:15px; border-radius:8px;">
                            <strong>Sistema Afectado:</strong> ${info.sistemas}
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('dtcCodeResults').innerHTML = `
                    <div class="pinout-result">
                        <p style="text-align:center; padding:40px;">‚ùå C√≥digo ${code} no encontrado en la base de datos</p>
                    </div>
                `;
            }
        }

        // ========== UI ==========
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            const tabElement = event?.target || document.querySelector(`[onclick*="${tab}"]`);
            if (tabElement) tabElement.classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }
    </script>
</body>
</html>
